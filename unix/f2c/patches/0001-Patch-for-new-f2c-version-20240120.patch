From c1d4a29a09edf01eaa380dfefbc215d198083fdc Mon Sep 17 00:00:00 2001
From: Ole Streicher <olebole@debian.org>
Date: Sun, 21 Jan 2024 11:56:36 +0100
Subject: [PATCH 1/5] Patch for new f2c version 20240120

---
 unix/f2c/src/format.c     |  4 +++-
 unix/f2c/src/formatdata.c |  3 +++
 unix/f2c/src/main.c       | 27 +++++++++++++++++++++++++--
 unix/f2c/src/version.c    |  4 ++--
 4 files changed, 33 insertions(+), 5 deletions(-)

diff --git a/unix/f2c/src/format.c b/unix/f2c/src/format.c
index c9549660f..e8ebea92d 100644
--- a/unix/f2c/src/format.c
+++ b/unix/f2c/src/format.c
@@ -80,7 +80,7 @@ static void proto Argdcl((FILEP, Argtypes*, char*));
 
 extern chainp assigned_fmts;
 char filename[P1_FILENAME_MAX];
-extern int gflag, sharp_line, trapuv;
+extern int gflag, sharp_line, trapuv, uselonglong;
 extern int typeconv[];
 int gflag1;
 extern char *parens;
@@ -2124,6 +2124,8 @@ do_uninit_equivs(FILE *outfile, int *did_one)
 	    if (!*did_one)
 		nice_printf (outfile, "/* System generated locals */\n");
 	    t = eqv->eqvtype;
+	    if (t == TYREAL && uselonglong)
+		t = TYLONG;
 	    if (last_type == t)
 		nice_printf (outfile, ", ");
 	    else {
diff --git a/unix/f2c/src/formatdata.c b/unix/f2c/src/formatdata.c
index 98d6cfde5..a6f11ddb7 100644
--- a/unix/f2c/src/formatdata.c
+++ b/unix/f2c/src/formatdata.c
@@ -34,6 +34,7 @@ static int memno2info Argdcl((int, Namep*));
 typedef unsigned long Ulong;
 
  extern char *initbname;
+ extern int uselonglong;
 
  void
 #ifdef KR_headers
@@ -1112,6 +1113,8 @@ wr_equiv_init(FILE *outfile, int memno, chainp *Values, int iscomm)
 			k = TYDREAL;
 			break;
 			}
+	if (uselonglong && k == TYREAL)
+		k = TYLONG;
 	type_choice[0] = k;
 
 	nice_printf(outfile, "%sstruct {\n", iscomm ? "" : "static ");
diff --git a/unix/f2c/src/main.c b/unix/f2c/src/main.c
index 977113dc3..141487c96 100644
--- a/unix/f2c/src/main.c
+++ b/unix/f2c/src/main.c
@@ -76,6 +76,7 @@ static char *def_i2 = "";
 
 static int useshortints = NO;	/* YES => tyint = TYSHORT */
 static int uselongints = NO;	/* YES => tyint = TYLONG */
+int uselonglong = NO;		/* YES => tyint = TYLONG; adjust typesizes for 64-bit ints */
 int addftnsrc = NO;		/* Include ftn source in output */
 int usedefsforcommon = NO;	/* Use #defines for common reference */
 int forcedouble = YES;		/* force real functions to double */
@@ -171,6 +172,7 @@ static arg_info table[] = {
     f2c_entry ("!i8const", P_NO_ARGS, P_INT, &allow_i8c, NO),
 #endif
     f2c_entry ("!i8", P_NO_ARGS, P_INT, &use_tyquad, NO),
+    f2c_entry ("I8", P_NO_ARGS, P_INT, &uselonglong, YES),
 #endif
 
 	/* options omitted from man pages */
@@ -241,7 +243,28 @@ set_externs(Void)
 
 /* Adjust the global flags according to the command line parameters */
 
-    if (chars_per_wd > 0) {
+
+    if (uselonglong) {
+	if (useshortints)
+		err("Can't use -I8 with -I2");
+	if (uselongints)
+		err("Can't use -I8 with -I4");
+	if (!tyioint)
+		err("Can't use -I8 with -i2");
+	if (chars_per_wd)
+		err("Can't use -I8 with -W");
+	typesize[TYADDR] = typesize[TYLONG] = typesize[TYDREAL] = typesize[TYCOMPLEX] = typesize[TYLOGICAL] = 8;
+	typesize[TYSHORT] = typesize[TYREAL] = typesize[TYLOGICAL2] = 4;
+	typesize[TYQUAD] = typesize[TYDCOMPLEX] = 16;
+	typesize[TYCILIST] = 40;
+	typesize[TYICILIST] = 48;
+	typesize[TYOLIST] = 72;
+	typesize[TYCLLIST] = 24;
+	typesize[TYALIST] = 16;
+	typesize[TYINLIST] = 208;
+	tyint = tylogical = tylog = TYLONG;
+	}
+    else if (chars_per_wd > 0) {
 	typesize[TYADDR] = typesize[TYLONG] = typesize[TYREAL] =
 		typesize[TYLOGICAL] = chars_per_wd;
 	typesize[TYINT1] = typesize[TYLOGICAL1] = 1;
@@ -468,7 +491,7 @@ I_args(int argc, char **a)
 		if (!(s = *a))
 			break;
 		if (*s == '-' && s[1] == 'I' && s[2]
-		  && (s[3] || s[2] != '2' && s[2] != '4'))
+		  && (s[3] || s[2] != '2' && s[2] != '4' && s[2] != '8'))
 			Iargs = mkchain(s+2, Iargs);
 		else
 			*a1++ = s;
diff --git a/unix/f2c/src/version.c b/unix/f2c/src/version.c
index b2606b299..ce7b3f2f1 100644
--- a/unix/f2c/src/version.c
+++ b/unix/f2c/src/version.c
@@ -1,2 +1,2 @@
-char F2C_version[] = "20200916";
-char xxxvers[] = "\n@(#) FORTRAN 77 to C Translator, VERSION 20200916\n";
+char F2C_version[] = "20240120";
+char xxxvers[] = "\n@(#) FORTRAN 77 to C Translator, VERSION 20240120\n";
-- 
2.43.0

